# EWMG Checkout

## Theme Setup

1. Copy `skin/frontend/base/default/vortex/css/_variables.less` and `skin/frontend/base/default/vortex/css/checkout.less` to your theme e.g. `skin/frontend/default/skywire/vortex/css/`.

2. Update `checkout.less` like so:

```
//
// Checkout
// --------


// Vendors

@import "../../../../base/default/vortex/css/vendors/_normalize.less";

// General

@import "_variables.less";
@import "../../../../base/default/vortex/css/_mixins.less";
@import "../../../../base/default/vortex/css/_debug.less";
@import "../../../../base/default/vortex/css/_styleguide.less";
@import "../../../../base/default/vortex/css/_general.less";
@import "../../../../base/default/vortex/css/_loader.less";
@import "../../../../base/default/vortex/css/_modal.less";
@import "../../../../base/default/vortex/css/_fonts.less";
@import "../../../../base/default/vortex/css/_form.less";
@import "../../../../base/default/vortex/css/_layout.less";
@import "../../../../base/default/vortex/css/_buttons.less";
@import "../../../../base/default/vortex/css/_header.less";
@import "../../../../base/default/vortex/css/_basket.less";
@import "../../../../base/default/vortex/css/_giftcard.less";
@import "../../../../base/default/vortex/css/_crosssell.less";
@import "../../../../base/default/vortex/css/_clickcollect.less";
@import "../../../../base/default/vortex/css/_register.less";
@import "../../../../base/default/vortex/css/_success.less";
@import "../../../../base/default/vortex/css/_amazonpayment";
@import "../../../../base/default/vortex/css/_errors";
@import "../../../../base/default/vortex/css/_cms";

```

3. Make the relevant changes to the `_variables.less` file for your theme. You can also copy across another LESS file that needs overriding in the same fashion.


4. Copy `skin/frontend/base/default/vortex/gruntfile.js` and `skin/frontend/base/default/vortex/package.json` to your theme directory (e.g. `skin/frontend/default/skywire/vortex/css/`) like above.

5. Then run on your terminal in your theme directory (e.g. `skin/frontend/default/skywire/vortex/css/`) run `npm install` and `grunt less` to compile the `checkout.css` file.


## Building the React app / developing locally

The checkout is built in the `app/code/community/Vortex/Checkout/js` folder using npm tooling. To build it, you simply run `npm install && npm build` and that will generate folders in `skin/frontend/base/default/vortex/checkout/static` and make those changes visible on the checkout within Magento. However continuously building to see a result can be quite cumbersome. 

Instead, it is possible to instantiate the checkout in ‘development mode’ and view changes on the react app outside of a Magento context. To see this, run `npm start` in `app/code/community/Vortex/Checkout/js`. This will create a local node server and boot the app. The app speaks to the Magento API still and is much easier to develop on, however it will lack any design changes made my layout xml inside of Magento. There are a few of caveats worth noting, that we seek to resolve in the future;

1. The local React environment instantiated by `npm start` will load on http://localhost:3000. As this is likely a different domain to your local EWMG project instance, you will need to make sure your CORs headers are set to allow cross origin for all HTTP verbs.

2. As all layouts are generated by Magento and the checkout css is inside Magento, it is currently required to manually copy the css  from within Magento to `app/code/community/Vortex/Checkout/js/src/checkout.css` _if_ you want to see css changes in ‘development mode’.

3. All local config is stored in `app/code/community/Vortex/Checkout/js/src/config.js`, you need to change those variables appropriately for you local environment.

## Magento System Configuration

### EWMG Checkout Configuration
Found under `System -> Configuration -> SALES -> EWMG Checkout`


#### AB Testing
This section is used to configure the enchanced version of the existing datalayer from the `Yireo_GoogleTagManager` extension. By including the following datalayer variables `googleOptimizeExperimentId` and `googleOptimizeExperimentVariation` this will then allow you to use Google Optimize in a server side mode.

| Experiment ID|This is to be populated from the Google Analytics ID from the experiment for example `YH6hkqTsWGWVJTiNshy9uQ`|
| Percentage to send to new checkout|This is used to decide the percentage split that the new checkout is served, please use 0-100.|


#### Postcode Anywhere
Field | Value
--- | ---
Lookup Key | This will likely be the same for all EWMG brands sites which for PSL and JNI is `KD95-EJ11-EP36-WY85`
Geocode Key | This will likely be the same for all EWMG brands sites which for PSL and JNI is `TN46-MR59-ZM56-ZG63`
Geocode Preferred Country | This is used for Click and Collect search only, so should be GB and supports ISO-ALPHA-2 country codes
Geocode Endpoint | *Do not change, this will be removed in future versions*

### WorldPay Configuration
Found under `System -> Configuration -> SALES -> WorldPay`

We have purposely omitted fields that are the same for all brands regardless of checkout.

#### Email Configuration
Field | Value
--- | ---
Disable Worldpay New Order Email | Yes

#### General Configuration
Field | Value
--- | ---
Enable Logging | No (for production)
Invoice and capture automatically| Yes
Payment method selection | Radio

#### Environment Configuration
Field | Value
--- | ---
Test URL| https://secure-test.worldpay.com/jsp/merchant/xml/paymentService.jsp
Live URL | https://secure.worldpay.com/jsp/merchant/xml/paymentService.jsp


#### Credit Cards
Field | Value
--- | ---
Require CVC | Yes
Client side encryption enabled | Yes
Client side encryption public key | Obtain from EWMG likely Josh Lowes or Michelle Beatty


### Additional Configuration

Unset all countries in `System -> Configuration -> GENERAL -> General -> State Options -> State is required for`. This is required because of an issue mapping Postcode Anywhere states to Magento states. This should be resolved in a future release once an implementation strategy is realised.


## Additional Notes

Please ignore the contents of `skin/frontend/base/default/vortex/checkout/static/media` and `skin/frontend/base/default/vortex/checkout/static/css` as these are not used by created via the React build process.
